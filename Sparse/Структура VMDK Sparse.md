
## Принцип работы MonolithicSparse
![[Снимок экрана 2024-10-27 224126.png]]

1. **Основой здесь лежит ЗЕРНО (grainSize)**.
		Зерно содержит в себе 128 секторов. => Размер зерна 64 Кб (есть также вариант с 128 Кб)
2. **Следом Запись таблицы (GTE) указывает на 1 зерно
		GTE** (Grain Table Entry) — это запись в таблице зерен, которая содержит информацию о свойствах конкретного зерна. Каждая запись GTE включает указатели и другую метаинформацию, необходимую для управления данным зерном.
	**Свойства зерна в GTE, если:** 
			**Размер**: 4 байта.
			**GTE = 0**: зерно не выделено.
				- Чтение вернёт нули (если нет родительского диска).
				- Первая запись в сектор инициализирует зерно.
			**GTE = 1**: зерно содержит только нули (zeroed grain).
				- Чтение вернёт нули
				- Первая запись выделяет зерно и инициализирует его нулями.
			**GTE > 1**: зерно уже выделено.
				Чтение и запись производятся в это зерно.
3. **GT (Grain Table) -таблица зерен**
		* 1 таблица зерен охватывает 32 Мб данных (если сектор равен 64 КБ) - это **покрытие зерен** gtCoverage
		* Содержит в себе 512 записей (512 штук GTE, которые в свою очередь содержат 1 зерно со своими **свойствами**)
		* Таблица, которая управляет местоположением данных, обеспечивая адресацию к конкретным зернам.
		* **Формула для вычисления общего кол-ва записей**
		Количество записей=Размер зерна / Общий объем диска
1. **Grain Directory Entry (GDE) - запись каталога зерен**
		**Размер**: 4 байта
		Запись каталога зерен — это смещение в секторах таблицы зерен в разреженном экстенте. Количество записей каталога зерен на каталог зерен (размер каталога зерен) зависит от длины экстента. Запись каталога зерен — это 32-битное количество
		Основные функции - управление таблицами. Позволяет найти эти таблицы. Но для начала нужно знать смещение байт (gdOffset в заголовке)
5. **GD - каталог зерен**
		Он 1 единственный (для нас)
		Содержит указатели на **Grain Directory Entries (GDE)**, которые предоставляют детальную информацию о каждом зерне, такой как его состояние и размер.		
## Формулы
Взято из vmdk_50_technote.pdf
![[Снимок экрана 2024-10-27 114100.png]]

### Поиск Grain Directory Entry (GDE)

Чтобы найти таблицу зерен, нужно определить нужный **Grain Directory Entry (GDE)** для сектора x. Формула для расчёта:

![[Снимок экрана 2024-10-27 223525.png]]

где `GD` — каталог зерен.

- В этой формуле **x/gtCoveragex** вычисляет индекс записи каталога зерен для данного сектора. Функция **floor** указывает на целое число, ближайшее к этому значению, не превышающее его, чтобы указать нужный **GDE**. 
### Поиск Grain Table Entry (GTE)

После нахождения нужной записи **GDE**, можно определить нужный **GTE**. Это делается с помощью формулы:

![[Снимок экрана 2024-10-27 223835.png]]

- Здесь **x % gtCoverage** — остаток от деления x на gtCoverage, который указывает на смещение внутри выбранной таблицы зерен.
- Полученное значение делится на grainSize, чтобы определить нужный **GTE**.

![[Снимок экрана 2024-10-27 223245.png]]

общее кол-во секторов
