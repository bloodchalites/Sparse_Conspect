Сектор 512 байт
Кластер - набор объединенных секторов от 1 до 128 секторов. (от 512 байт до 64 КБ).
Наш кластер 4КБ - 8 секторов
![[Pasted image 20241118125021.png]]
Фото показывает как будет выделяться память для 10 байтового файла (т.е. 1 кластер)
Всю Файловую систему можно разделить на 3 пункта:

## **Основная структура FAT32**

| Служебная информация |
| -------------------- |
| Таблицы FAT          |
| Данные Файлов        |

## **Организация файловых систем FAT16 и FAT32**

![[Pasted image 20241119132119.png]]

0 сектор MBR - физ. диск
## **Master Boot Record**

| **Master Boot Record** | **Байты   {512 }** |                                          | **Примечание**                                                                |
| ------------------ | -------------- | ---------------------------------------- | ------------------------------------------------------------------------- |
| 0x000              | 446            | Исполняемый код                          |                                                                           |
| 0x1BE - 0x1CA      | 16             | Описание раздела 1                       | Структуры с информацией о 4-х разделах диска. 1 из них является активным. |
| 0x1CE              | 16             | Описание раздела 2                       |                                                                           |
| 0x1DE              | 16             | Описание раздела 3                       |                                                                           |
| 0x1EE              | 16             | Описание раздела 4                       |                                                                           |
| 0x1FE              | 2              | { AA 55 } Сигнатура загрузочного раздела |                                                                           |

В разделе 1 (активном разделе) есть Загрузочный сектор, который нужно найти. Чтобы его найти используется Описание раздела 1 ( соответственно ). Вот структура из 10 полей.

| **0x1BE - 0x1CA** | **16** | **Описание раздела 1**          | **Структуры с информацией о 4-х разделах диска. 1 из них является активным.** |
| ----------------- | ------ | ------------------------------- | ----------------------------------------------------------------------------- |
| 0x1BE             | 1      | 80 - активен /<br>0 - неактивен | Флаг (признак) активности этого раздела                                       |
| 0x1BF             | 1      | 00                              | Начало раздела - Головка                                                      |
| 0x1C0             | 1      | 00                              | Начало раздела - Сектор                                                       |
| 0x1C1             | 1      | 00                              | Начало раздела - Цилиндр                                                      |
| 0x1C2             | 1      | 0B                              | Тип Файловой системы раздела - FAT32                                          |
| 0x1C3             | 1      | 00                              | Конец раздела - Головка                                                       |
| 0x1C4             | 1      | 00                              | Конец раздела - Сектор                                                        |
| 0x1C5             | 1      | 00                              | Конец раздела - Цилиндр                                                       |
| 0x1C6             | 4      | 00 00 00 3F                     | Смещение до раздела в секторах - 63                                           |
| 0x1CA             | 4      | AA 55 00 00                     | Кол-во секторов раздела                                                       |

Служебная информация начинается с загрузочного сектора:
Которая находится в 0 секторе каждого раздела. Занимает ровно 1 сектор

## **Расширенный блок параметров BIOS (BIOS Parametr Block)**

Структура 0 сектора Раздела
Биос может находится в 63 секторе от начала диска. Биос - 0x7E00. 


| Bios Parametr Block | Байты |                        | Название                                       | Примечание                                                             |
| :------------------ | :---- | :--------------------- | :--------------------------------------------- | :--------------------------------------------------------------------- |
| 0x00                | 3     | EB5A90                 | jmp 5A nop  - переход к загрузочному коду      | jmp - переход по адресу своего операнда, там находится загрузочный код |
| 0x03                | 8     | 4D53444F53352E30       | Метка ОС (ASCII)                               | Может быть MSDOS5.0 или MSWIN4.1                                       |
| 0x0B                | 2     | 0200                   | Размер сектора в байтах - 512                  |                                                                        |
| 0x0D                | 1     | 08                     | Кол-во секторов в кластере - 8                 |                                                                        |
| 0x0E                | 2     | 0020                   | Размер резервной области в секторах 32         |                                                                        |
| 0x10                | 1     | 02                     | Кол-во копий таблиц FAT                        | Нужно в случае восстановления данных                                   |
| 0x11                | 2     | 0000                   | Кол-во элементов корн. каталога                |                                                                        |
| 0x13                | 2     | 0000                   | Всего секторов в разделе                       | старое для FAT316                                                      |
| 0x15                |       | F8                     | Тип носителя                                   | 0xF8 -жесткий диск<br>0xF0 - съемный диск                              |
| 0x16                | 2     | 0000                   | Размер таблицы FAT в секторах                  |                                                                        |
| 0x18                | 2     | 003F                   | Кол-во секторов на дорожке                     |                                                                        |
| 0x1A                | 2     | 00FF                   | кол-во головок                                 |                                                                        |
| 0x1C                | 4     | 00000000               | Кол-во секторов перед началом тома             |                                                                        |
| 0x20                | 4     | 00E6B068               | Всего секторов в разделе                       | новое для FAT32                                                        |
| 0x24                |       | 0000E70                | Размер таблицы FAT в секторах                  | тут: 3696512 = 1,8 МБ                                                  |
| 0x28                | 2     | 0000                   | Флаги                                          | Никто уже не использует                                                |
| 0x2A                | 2     | 0000                   | Номер версии                                   | Никто уже не использует                                                |
| 0x2C                | 4     | 00000002               | Смещение до кластера корневого каталога        |                                                                        |
| 0x30                | 2     | 0001                   | Сектор с FSINFO                                | Значит корневой каталог будет следующим сектором                       |
| 0x32                | 2     | 0006                   | Сектор с резервной копией служебной информации |                                                                        |
| 0x34                | 12    | 00000..                | Зарезервированные поля                         | Заполняются нулями                                                     |
| 0x40                | 1     | 80                     | Номер диска                                    |                                                                        |
| 0x41                | 1     | 00                     | Флаги                                          | Никто уже не использует                                                |
| 0x42                | 1     | 29                     | Расширенная загрузочная запись                 |                                                                        |
| 0x43                | 4     | 1B042F55               | Серийный номер тома                            | Случайное число                                                        |
| 0x47                | 11    | 4E4F204E414D4520202020 | Метка тома (ASCII) - NO NAME                   |                                                                        |
| 0x52                | 8     | 4641543332202020       | Тип файловой системы (ASCII) - FAT32           |                                                                        |
| 0x5A                | 420   | 00000...               | Загрузочный код                                | То место куда идет переход jmp                                         |
| 0x1FOE              | 2     | AA55                   | Сигнатура загрузочного сектора                 |                                                                        |

![[Pasted image 20241119133243.png]]
**Размер Кластера:**
Кол-во секторов в кластере (8) * Размер секторов (512) = 4КБ

**Адрес 1-й таблицы FAT:**
Размер резервной области 32 сектора (0x20) * Размер сектора в байтах (0x200)
0x20 * 0x200 = 0x4000

**Адрес копии таблицы FAT**
**(Размер резервной области - 32 + Размер таблицы FAT  в секторах 3696) * Размер сектора**
(32 + 3696 ) * 512 = 0x1D2000
(0x20 + 0xE70) * 0x200 = 0x1D2000

**Адрес ROOT-каталога*
 LBA каталога можно найти по формуле из ВРВ:  
`RsvdSecCount + (FATSz*2) + ((RootCluster-2) * SecPerCluster)`
(0x20+0xE70 * 2)+(2-2 * 0x08) * 0x200 = 0x3A0000
2 смещение до кластера корневого каталога

## **FSINFO**


| FSINFO | Байты | Пример   | Название                                                      | Примечание                                              |
| ------ | ----- | -------- | ------------------------------------------------------------- | ------------------------------------------------------- |
| 0x200  | 4     | 41615252 | Сигнатура FSINFO                                              |                                                         |
| 0x204  | 479   | 00000... | Зарезервировано                                               |                                                         |
| 0x3E4  | 4     | 61417272 | Сигнатура                                                     |                                                         |
| 0x3E8  | 4     | FFFFFFFF | Последнее известное значение свободных кластеров тома         | Если FF то число свободных кластеров пока не известно   |
| 0x3EC  | 4     | FFFFFFFF | Номер кластера, с которого начнется поиск свободных кластеров | Если FF то поиск начинается с самого начала FAT таблицы |
| 0x3F0  | 12    | 0000.... | Зарезервированно                                              |                                                         |
| 0x3FC  | 4     | AA550000 | Сигнатура                                                     |                                                         |

Далее идут секторы зарезервированные нулями (4 сектора) => до 6-го сектора с FSINFO.

| Зарезервированно |              | сектор   |
| ---------------- | ------------ | -------- |
| 0x400            | 00000000.... | 2 сектор |
| 0x600            | 00000000.... | 3 сектор |
| 0x800            | 00000000.... | 4 сектор |
| 0xA00            | 00000000.... | 5 сектор |
Начиная с 6-го сектора идут секторы с резервными копиями 2-х этих структур и еще зарезервированные сектора до 31 сектора вплоть до таблицы FAT - 32 сектор

| Зарезервированно |             | Копия        | сектор   | Байты |
| ---------------- | ----------- | ------------ | -------- | ----- |
| 0xC00            | EB5A90..... | Копия EBPB   | 6 сектор | 512   |
| 0xE00            | 41615252    | Копия FSINFO | 7 сектор | 512   |
| 0x1000           | 0000000     | Резерв       | 8-31     | 12288 |

## **Таблицы FAT1 - 32 сектор**
Представляет собой разметку кластеров

| Зарезервированно | Байты | Копия                                      | Указатель на Кластер | Пример   | Примечание                                              |
| ---------------- | ----- | ------------------------------------------ | -------------------- | -------- | ------------------------------------------------------- |
| 0x4000           | 4     | Сигнатура                                  | не является          | 0FFFFFF8 | Последний байт значения определяет тип этого устройства |
| 0x4004           | 4     | Сигнатура                                  | не является          | FFFFFFFF | F0 - floopy<br>F8 - hard<br>FA - ram                    |
| 0x4008           | 4     | Кластер                                    | 2                    | 0FFFFFFF | Всегда метка об окончании кластеров файла               |
| 0x400C           | 4     | Кластер                                    | 3                    | 00000004 | Каждая ячейка кластера хранит номер следующего кластера |
| 0x4010           | 4     | Кластер                                    | 4                    | 00000005 |                                                         |
| 0x4014           | 4     | Кластер                                    | 5                    | 00000006 |                                                         |
| 0x4018           | 4     | Кластер                                    | 6                    | 0FFFFFFF | кластер 9 - метка об окончании кластеров файла          |
| 0x401C           | 4     | Кластер                                    | 7                    | 00000008 |                                                         |
| 0x4020           | 4     | Кластер                                    | 8                    | 00000009 |                                                         |
| 0x4024           | 4     | Кластер                                    | 9                    | 0FFFFFFF | кластер 9 - метка об окончании кластеров файла          |
| 0x....           | ...   | ...                                        | ...                  |          |                                                         |
| 0x1D2000         | 3696  | Таблица FAT2. Резервная копия таблицы FAT1 |                      |          | Это будет 3728 сектор                                   |
Чтобы узнать где заканчиваются указатели кластеров нашего файла от кластеров другого файла нужно найти специальные маркеры: 

| Конец файла    | 0FFFFFFF |
| -------------- | -------- |
| Свободен       | 00000000 |
| Выделен        | 00000002 |
| Зарезервирован | 0FFFFFF6 |
| Поврежден      | 0FFFFFF7 |

## **Корневой каталог (ROOT-директория)**
**Адрес ROOT-каталога*
 LBA каталога можно найти по формуле из ВРВ:  
`RsvdSecCount + (FATSz*2) + ((RootCluster-2) * SecPerCluster)`
(0x20+0xE70 * 2)+(2-2 * 0x08) * 0x200 = 0x3A0000
2 смещение до кластера корневого каталога

1. Первая структура SFN _(синий блок)_ будет всегда описывать корневую папку диска. Это единственная структура, которой может быть присвоен атрибут "VolumeID" со-значением 08h. Атрибуты файлов/каталогов лежат по смещению(0Вh) от начала структур, и я заключил их в синий овал. Все остальные поля первой структуры SFN считаются не действительными!​

2. На моей флэш всего два файла с именами "dCrypt.asm" и "usbVIDbase.txt". Чем руководствуется драйвер FAT при добавлении к SFN структуры LFN остаётся загадкой, поскольку имя первого файла меньше 8-ми символов, но дров всё-равно вставил LFN _(см.красный блок)_. А вот имя второго файла уже 10-символов, и для него выделено две LFN в зелёном блоке. Обратите внимание, что у первой в поле-ординала лежит значение(1) _(+40h маска)_, а у второй LFN ординал равен(2). Эти поля я выделил чёрным, и они определяют кол-во структур LFN для текущего файла. Записи LFN можно обнаружить по атрибуту(0F).

![[Pasted image 20241119142145.png]]
![[Pasted image 20241119141750.png]]

Из чёрной таблицы с расшифровкой полей видно, что номер первого кластера разделён на две части Hi/Low. Первый файл "dCrypt.asm" размером 7.4КБ и начинается с кластера(3). Но поскольку он требует два 4К-байтных, следующий указывается уже в таблице FAT _(см.зелёный dword на предыдущем скрине)_. Здесь нужно отметить, что номера кластеров представляются относительно начала области-данных, которая совпадает с началом рассматриваемого корневого-каталога RootDir.

Так как-же найти злополучный файл на диске?  
Для этого в спеке FAT32 приведена формула такого вида: `FileFirstCluster = RootDir + (SFN.FstClus - RootCluster)`  
Если учесть, что в стандартной реализации FAT32 поле "RootCluster" в структуре ВРВ всегда равно 2, то для первого файла получаем следующий сектор LBA:  
Код:

```
RootDir       = сектор 16384
SFN.FstClus   = кластер(3)
Формула: 3-2  = кластер(1) = 8 секторов
-----------------------------------------
FileFirstClus = 16384 + 8 = сектор(16392)
```
## **Структура LFN**

Так как человеку не хватает 8 символом под название образуется структура LFN.Занимает 32 байта (позволяет хранить 13 символов). Следовательно если число символов будет превышать то новый LFN №2 будет идти за первым LFN №1.
Если название меньше 8-ми символов то оставшиеся символы будут пробелами.

| SFN корневого каталога | 32 байта |             |                                                     |                                                                                                              |
| ---------------------- | -------- | ----------- | --------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| LFN                    | Байты    | Пример      | Название                                            | Примечание                                                                                                   |
|                        | 1        | 41          | Номер структуры в наборе структур с длинными именем | 0x40+номер<br>Если E5 то файл не нужен(был удален)<br>А кластер на удаляемый файл просто записывается нулями |
|                        | 10       | 0000000.... | Символы с 1 по 5 (Unicode)                          |                                                                                                              |
|                        | 1        | 0F          | атрибут                                             | Означает хранение длинного имени                                                                             |
|                        | 1        | 00          | Зарезервированно                                    |                                                                                                              |
|                        | 1        | 00          | Контрольная сумма                                   |                                                                                                              |
|                        | 12       | 0000000.... | Символы с 6 по 11 (Unicode)                         |                                                                                                              |
|                        | 2        | 0000        | Зарезервированно                                    |                                                                                                              |
|                        | 4        | FFFFFFFF    | Символы с 12 по 13 (Unicode)                        |                                                                                                              |

## **Структура SFN** 


| ==Все это можно назвать структура SFN файла== | ==В случае если имя длинное за SFN появляется структура LFN== | ==Она будет представлена сверху== |                                               |                                                                                                                                                       |
| --------------------------------------------- | ------------------------------------------------------------- | --------------------------------- | --------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| ROOT                                          | Байты                                                         | Пример                            | Название                                      | Примечание                                                                                                                                            |
| 0x3A0000                                      | 11<br>8 -имя файла<br>3 - расширение                          | 20934820983423..                  | Имя файла (проблематично хранится)            | Называется еще short file name (SFN)                                                                                                                  |
| 0x3A000B                                      | 1                                                             | 20                                | Атрибут файла /каталога                       | 01 - только для чтения<br>02 - скрытый файл<br>04 - системный файл<br>08 - метка тома<br>0F - длинное имя файла<br>10 - каталог<br>20 - архивный файл |
| 0x3A000C                                      | 1                                                             | 00                                | Метка регистров                               | 00001000 - имя отображать в нижнем регистре<br>00011000 - вместе с расширением в нижнем регистре                                                      |
| 0x3A000D                                      | 1                                                             | 00                                | Миллисекунды создания файла                   |                                                                                                                                                       |
| 0x3A000E                                      | 2                                                             | 0000                              | Время создания                                |                                                                                                                                                       |
| 0x3A0010                                      | 2                                                             | 0000                              | Дата Создания                                 |                                                                                                                                                       |
| 0x3A0012                                      | 2                                                             | 0000                              | Дата последнего доступа (чтение, запись)      |                                                                                                                                                       |
| 0x3A0014                                      | 2                                                             | 0000                              | 2 старших байта адреса первого кластера файла |                                                                                                                                                       |
| 0x3A0016                                      | 2                                                             | 9CBB                              | Время последнего изменения модификации файла  |                                                                                                                                                       |
| 0x3A0018                                      | 2                                                             | 474D                              | Дата последней модийикации файла              |                                                                                                                                                       |
| 0x3A001A                                      | 2                                                             | 0003                              | 2 Младших байта адреса первого кластера файла |                                                                                                                                                       |
| 0x3A001C                                      | 4                                                             | 0000000B                          | Размер файла в байтах                         | => макс 4 ГБ                                                                                                                                          |

## **Нахождение конкретного адреса блока с данными**

 + Размер таблицы FAT * 2, т.к. у нас 2 таблицы вторая копия
	 **(Размер резервной области - 32 + Размер таблицы FAT  в секторах 3696)** = 7424 сектора
+ 2 смещение до кластера корневого каталога умноженное на кол-во секторов в кластере - 8: (2-2 * 0x08)
+ смещение кластера от начала корневого каталога: (3-2) * 0x08
+ Итого: (0x20+0xE70 * 2)+((2-2) * 0x08)+((3-2) * 0x08)
+ Перевод в адрес, умножаем все на размер сектора: * 0x200 

## **Что на практике?**

**1. Загрузочная запись и блок** **BPB – Bios Parametr** **Block**

 ВРВ критически важен для драйвера, посколько именно в нём зарыта инфа о расположении оставшихся трёх/системных структур – это парочка FAT, и корневой каталог RootDir.
 ![[Pasted image 20241119131533.png]]


**Корневой каталог** всегда расположен сразу после двух таблиц FAT, т.е. адрес его фиксирован.


![[Pasted image 20241119131741.png]]

На рисунке ниже представлен фрагмент таблицы FAT _(для удобства, в меню "Вид" сгруппируйте отображение по 4-байта)_.  
  
• Два/первых элемента массива всегда равны `0x0FFFFFF8` + `0xFFFFFFFF`, и не используются в качестве указателей на кластеры – это просто сигнатура таблицы, а байт(F8) определяет "MediaType" _(варианты: F0=Floppy, F8=Hard, FA=Ram).

![[Pasted image 20241119131957.png]]
